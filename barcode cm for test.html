<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Thermal Label Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      .control-active {
        background-color: #06b6d4 !important;
        color: #111827 !important;
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      /* Toggle Switch CSS */
      .toggle-container {
        display: flex;
        align-items: center;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 24px;
        margin-left: auto;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #4b5563;
        transition: 0.4s;
        border-radius: 24px;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .toggle-slider {
        background-color: #06b6d4;
      }
      input:checked + .toggle-slider:before {
        transform: translateX(16px);
      }
      @media print {
        #controls-panel,
        #settings-modal,
        #svg-library-modal {
          display: none;
        }
        .print-hidden {
          display: none !important;
        }
        body,
        .w-full.max-w-6xl {
          margin: 0 !important;
          padding: 0 !important;
          box-shadow: none !important;
          background: none !important;
        }
        .w-full.max-w-6xl {
          display: block;
        }
        #print-area {
          position: static;
          padding: 0;
          margin: 0;
        }
        #label-preview {
          margin: 0 !important;
          padding: 0 !important;
          box-shadow: none !important;
          border-radius: 0 !important;
          border: none !important;
          transform: scale(1) !important;
          box-sizing: border-box;
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8"
  >
    <div
      class="w-full max-w-6xl bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8"
    >
      <div id="controls-panel" class="flex flex-col space-y-6">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-bold text-cyan-400">
              Thermal Label Designer
            </h1>
            <p class="text-gray-400 mt-1">
              Customize your label below and print it.
            </p>
          </div>
          <button
            id="settings-button"
            class="p-2 rounded-full hover:bg-gray-700"
            aria-label="Open settings"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg">
          <h2 class="text-lg font-semibold mb-3 border-b border-gray-600 pb-2">
            Label Content
          </h2>
          <div class="space-y-4">
            <div>
              <label for="text-label1" class="block text-sm">Label 1 Text</label
              ><textarea
                id="text-label1"
                rows="2"
                class="mt-1 block w-full bg-gray-800 rounded-md p-2"
                dir="auto"
              ></textarea>
            </div>
            <div>
              <label for="text-label2" class="block text-sm">Label 2 Text</label
              ><textarea
                id="text-label2"
                rows="2"
                class="mt-1 block w-full bg-gray-800 rounded-md p-2"
                dir="auto"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg space-y-4">
          <div
            class="flex items-center justify-between border-b border-gray-600 pb-2"
          >
            <h2 class="text-lg font-semibold">Styling</h2>
            <div id="styling-tabs" class="flex p-1 bg-gray-800 rounded-lg">
              <button id="tab-label1" class="px-3 py-1 text-sm rounded-md">
                Label 1</button
              ><button id="tab-label2" class="px-3 py-1 text-sm rounded-md">
                Label 2
              </button>
            </div>
          </div>
          <div class="space-y-4">
            <div class="grid grid-cols-3 items-center gap-4">
              <label for="font-size" class="text-sm col-span-1"
                >Font Size</label
              >
              <div class="col-span-2 flex items-center gap-3">
                <input
                  type="range"
                  id="font-size"
                  min="8"
                  max="48"
                  class="w-full"
                /><input
                  type="number"
                  id="font-size-value"
                  min="8"
                  max="48"
                  class="w-16 p-1 text-center bg-gray-800 rounded-md"
                />
              </div>
            </div>

            <div class="grid grid-cols-3 items-center gap-4">
              <label for="line-spacing" class="text-sm col-span-1"
                >Line Spacing</label
              >
              <div class="col-span-2 flex items-center gap-3">
                <input
                  type="range"
                  id="line-spacing"
                  min="0.8"
                  max="3"
                  step="0.1"
                  value="1.5"
                  class="w-full"
                />
                <span
                  id="line-spacing-value"
                  class="w-16 p-1 text-center bg-gray-800 rounded-md"
                  >1.5</span
                >
              </div>
            </div>

            <div class="grid grid-cols-3 items-center gap-4">
              <label class="text-sm col-span-1">Text Style</label>
              <div class="col-span-2 flex items-center gap-2 flex-wrap">
                <button
                  id="font-weight-toggle"
                  class="p-2 w-10 h-10 bg-gray-800 rounded-md font-bold"
                >
                  B
                </button>
                <div
                  id="text-align-buttons"
                  class="flex bg-gray-800 rounded-md"
                >
                  <button
                    data-align="left"
                    class="p-2 w-10 h-10"
                    title="Align Left"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 9.75A.75.75 0 012.75 9h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 9.75zM2.75 14a.75.75 0 000 1.5h14.5a.75.75 0 000-1.5H2.75z"
                      />
                    </svg></button
                  ><button
                    data-align="center"
                    class="p-2 w-10 h-10"
                    title="Align Center"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM4.75 9a.75.75 0 01.75-.75h8.5a.75.75 0 010 1.5h-8.5A.75.75 0 014.75 9zm-2 4.75A.75.75 0 012.75 13h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z"
                      />
                    </svg></button
                  ><button
                    data-align="right"
                    class="p-2 w-10 h-10"
                    title="Align Right"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 9.75A.75.75 0 012.75 9h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 9.75zm14.5 4.5a.75.75 0 000-1.5H2.75a.75.75 0 000 1.5h14.5z"
                      />
                    </svg>
                  </button>
                </div>
                <div
                  id="vertical-align-buttons"
                  class="flex bg-gray-800 rounded-md"
                >
                  <button
                    data-v-align="start"
                    class="p-2 w-10 h-10"
                    title="Align Top"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 4h18M3 8h18M9 14h6v-4H9v4z"
                      ></path>
                    </svg></button
                  ><button
                    data-v-align="center"
                    class="p-2 w-10 h-10"
                    title="Align Middle"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6M3 4h18M3 20h18"
                      ></path>
                    </svg></button
                  ><button
                    data-v-align="end"
                    class="p-2 w-10 h-10"
                    title="Align Bottom"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 20h18M3 16h18M9 10h6V6H9v4z"
                      ></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-gray-700 p-4 rounded-lg space-y-4">
          <div
            class="flex items-center justify-between border-b border-gray-600 pb-2"
          >
            <h2 class="text-lg font-semibold">Image & Icon</h2>
            <button
              id="manage-svgs-button"
              class="text-sm bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-1 px-3 rounded-lg"
            >
              Manage SVGs
            </button>
          </div>
          <div class="grid grid-cols-3 items-center gap-4">
            <label for="svg-select" class="text-sm col-span-1">Select SVG</label
            ><select
              id="svg-select"
              class="col-span-2 bg-gray-800 rounded-md p-2"
            >
              <option value="none">None</option>
            </select>
          </div>
          <div class="grid grid-cols-3 items-center gap-4">
            <label for="svg-size" class="text-sm col-span-1">Icon Size</label>
            <div class="col-span-2 flex items-center gap-3">
              <input
                type="range"
                id="svg-size"
                min="12"
                max="96"
                value="24"
                class="w-full"
              /><span
                id="svg-size-value"
                class="w-16 p-1 text-center bg-gray-800 rounded-md"
                >24px</span
              >
            </div>
          </div>
          <div class="grid grid-cols-3 items-center gap-4">
            <label for="svg-count" class="text-sm col-span-1">Repetitions</label
            ><input
              type="number"
              id="svg-count"
              min="1"
              max="10"
              value="1"
              class="w-20 p-1 text-center bg-gray-800 rounded-md"
            />
          </div>
          <div class="grid grid-cols-3 items-center gap-4">
            <label class="text-sm col-span-1">Position</label>
            <div id="svg-position-buttons" class="flex bg-gray-800 rounded-md">
              <button
                data-pos="left"
                class="p-2 w-10 h-10"
                title="Position Left"
              >
                L</button
              ><button
                data-pos="right"
                class="p-2 w-10 h-10"
                title="Position Right"
              >
                R</button
              ><button
                data-pos="top"
                class="p-2 w-10 h-10"
                title="Position Top"
              >
                T</button
              ><button
                data-pos="bottom"
                class="p-2 w-10 h-10"
                title="Position Bottom"
              >
                B
              </button>
            </div>
          </div>
        </div>

        <button
          id="print-button"
          class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg"
        >
          Print Label
        </button>
      </div>

      <div
        class="flex items-center justify-center bg-gray-900/50 rounded-lg p-4"
        id="print-area"
      >
        <div
          id="label-preview"
          class="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col relative"
        >
          <div
            id="preview-label1"
            class="text-black h-1/2 box-border relative overflow-hidden"
          ></div>
          <hr
            class="absolute top-1/2 left-0 w-full -translate-y-1/2 border-t border-dashed border-gray-400 print-hidden"
          />
          <div
            id="preview-label2"
            class="text-black h-1/2 box-border relative overflow-hidden"
          ></div>
        </div>
      </div>
    </div>

    <div
      id="settings-modal"
      class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-gray-800 rounded-2xl p-8 w-full max-w-md relative overflow-y-auto max-h-full"
      >
        <button id="close-settings-button" class="absolute top-4 right-4">
          ❌
        </button>
        <h2 class="text-2xl font-bold text-cyan-400 mb-6">Settings</h2>
        <div class="bg-gray-700 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3 border-b border-gray-600 pb-2">
            Page Dimensions
          </h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="label-width" class="block text-sm">Width (cm)</label
              ><input
                type="number"
                id="label-width"
                value="5.7"
                step="0.1"
                class="mt-1 w-full bg-gray-900 rounded-md p-2"
              />
            </div>
            <div>
              <label for="label-height" class="block text-sm">Height (cm)</label
              ><input
                type="number"
                id="label-height"
                value="3.2"
                step="0.1"
                class="mt-1 w-full bg-gray-900 rounded-md p-2"
              />
            </div>
          </div>
        </div>

        <div class="bg-gray-700 p-4 rounded-lg mt-4">
          <h3 class="text-lg font-semibold mb-3 border-b border-gray-600 pb-2">
            Global Logo
          </h3>
          <div class="space-y-4">
            <div class="grid grid-cols-3 items-center gap-4">
              <label for="logo-svg-select" class="text-sm col-span-1"
                >Select Logo</label
              ><select
                id="logo-svg-select"
                class="col-span-2 bg-gray-900 rounded-md p-2"
              >
                <option value="none">None</option>
              </select>
            </div>
            <div class="grid grid-cols-3 items-center gap-4">
              <label for="logo-svg-size" class="text-sm col-span-1"
                >Logo Size</label
              >
              <div class="col-span-2 flex items-center gap-3">
                <input
                  type="range"
                  id="logo-svg-size"
                  min="12"
                  max="96"
                  value="24"
                  class="w-full"
                /><span
                  id="logo-svg-size-value"
                  class="w-16 p-1 text-center bg-gray-900 rounded-md"
                  >24px</span
                >
              </div>
            </div>
            <div class="grid grid-cols-3 items-center gap-4">
              <label class="text-sm col-span-1">Position</label>
              <div
                id="logo-svg-position-buttons"
                class="flex bg-gray-900 rounded-md"
              >
                <button
                  data-pos="left"
                  class="p-2 w-10 h-10"
                  title="Position Left"
                >
                  L</button
                ><button
                  data-pos="right"
                  class="p-2 w-10 h-10"
                  title="Position Right"
                >
                  R</button
                ><button
                  data-pos="top"
                  class="p-2 w-10 h-10"
                  title="Position Top"
                >
                  T</button
                ><button
                  data-pos="bottom"
                  class="p-2 w-10 h-10"
                  title="Position Bottom"
                >
                  B
                </button>
              </div>
            </div>
            <div class="toggle-container">
              <label for="logo-line-toggle" class="text-sm"
                >Show Separator Line</label
              >
              <label class="toggle-switch">
                <input type="checkbox" id="logo-line-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="mt-6">
          <button
            id="save-settings-button"
            class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg"
          >
            Save Settings
          </button>
        </div>
      </div>
    </div>
    <div
      id="svg-library-modal"
      class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden"
    >
      <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-2xl relative">
        <button id="close-svg-modal-button" class="absolute top-4 right-4">
          ❌
        </button>
        <h2 class="text-2xl font-bold text-cyan-400 mb-6">SVG Library</h2>
        <div class="bg-gray-700 p-4 rounded-lg mb-4 space-y-3">
          <h3 class="text-lg">Add New SVG</h3>
          <div class="flex items-end gap-4">
            <div class="flex-grow">
              <label for="new-svg-name" class="text-sm">SVG Name</label
              ><input
                type="text"
                id="new-svg-name"
                placeholder="e.g., Pill, Logo"
                class="mt-1 w-full bg-gray-900 rounded-md p-2"
              />
            </div>
            <div class="flex-grow">
              <label for="new-svg-upload" class="text-sm">SVG File</label
              ><input
                type="file"
                id="new-svg-upload"
                accept=".svg"
                class="mt-1 w-full text-sm"
              />
            </div>
            <button
              id="add-svg-button"
              class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg h-10"
            >
              Add
            </button>
          </div>
        </div>
        <div
          id="svg-gallery"
          class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-80 overflow-y-auto bg-gray-900 p-4 rounded-lg"
        ></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const textInputs = {
          label1: document.getElementById("text-label1"),
          label2: document.getElementById("text-label2"),
        };
        const previewElements = {
          label1: document.getElementById("preview-label1"),
          label2: document.getElementById("preview-label2"),
        };
        const labelPreview = document.getElementById("label-preview");
        const styleControls = {
          tabs: {
            label1: document.getElementById("tab-label1"),
            label2: document.getElementById("tab-label2"),
          },
          fontSize: document.getElementById("font-size"),
          fontSizeValue: document.getElementById("font-size-value"),
          lineSpacing: document.getElementById("line-spacing"),
          lineSpacingValue: document.getElementById("line-spacing-value"),
          fontWeightToggle: document.getElementById("font-weight-toggle"),
          textAlignButtons: document.getElementById("text-align-buttons"),
          verticalAlignButtons: document.getElementById(
            "vertical-align-buttons"
          ),
        };
        const imageControls = {
          select: document.getElementById("svg-select"),
          size: document.getElementById("svg-size"),
          sizeValue: document.getElementById("svg-size-value"),
          count: document.getElementById("svg-count"),
          position: document.getElementById("svg-position-buttons"),
          manageBtn: document.getElementById("manage-svgs-button"),
        };
        const svgModalControls = {
          modal: document.getElementById("svg-library-modal"),
          closeBtn: document.getElementById("close-svg-modal-button"),
          nameInput: document.getElementById("new-svg-name"),
          fileInput: document.getElementById("new-svg-upload"),
          addBtn: document.getElementById("add-svg-button"),
          gallery: document.getElementById("svg-gallery"),
        };
        const logoControls = {
          select: document.getElementById("logo-svg-select"),
          size: document.getElementById("logo-svg-size"),
          sizeValue: document.getElementById("logo-svg-size-value"),
          position: document.getElementById("logo-svg-position-buttons"),
          lineToggle: document.getElementById("logo-line-toggle"),
        };
        const settingsButtons = {
          save: document.getElementById("save-settings-button"),
        };

        let state = {
          label1: {
            text: "",
            size: 16,
            weight: "normal",
            align: "center",
            v_align: "start",
            line_height: 1.5,
            svg_name: "none",
            svg_count: 1,
            svg_position: "left",
            svg_size: 24,
          },
          label2: {
            text: "",
            size: 16,
            weight: "normal",
            align: "center",
            v_align: "start",
            line_height: 1.5,
            svg_name: "none",
            svg_count: 1,
            svg_position: "left",
            svg_size: 24,
          },
        };
        let logoState = {
          svg_name: "none",
          svg_position: "left",
          svg_size: 24,
          line_enabled: false,
        };
        let activeStyleTarget = "label1";
        let svgLibrary = [];

        function updatePreview() {
          Object.keys(previewElements).forEach((key) => {
            const current_state = state[key];
            const element = previewElements[key];
            element.innerHTML = "";
            element.style.padding = "0px"; // Reset padding

            // --- SETUP ---
            const rawText = textInputs[key].value;
            state[key].text = rawText; // Save text to state
            const textWithBreaks = rawText.replace(/\n/g, "<br>");
            const textContent = convertToArabicNumerals(textWithBreaks);
            let paddings = { top: 4, right: 4, bottom: 4, left: 4 };

            // --- 1. LOGO RENDERING LOGIC ---
            let logoSvgContainer = "";
            const selectedLogoData = svgLibrary.find(
              (item) => item.name === logoState.svg_name
            );

            if (logoState.svg_name !== "none" && selectedLogoData) {
              const logoSvgStyle = `style="width:${logoState.svg_size}px; height:${logoState.svg_size}px;"`;
              const singleLogoSvgHtml = `<div class="svg-instance" ${logoSvgStyle}>${selectedLogoData.svg}</div>`;
              const logoSvgContent = singleLogoSvgHtml;
              let logoPositionStyle = "";

              let logoPaddingSize = parseInt(logoState.svg_size, 10) + 8;
              if (logoState.line_enabled) {
                logoPaddingSize += 5; // Add space for line and gap
              }

              const lineStyle = logoState.line_enabled
                ? "1px solid #ccc"
                : "0px solid transparent";

              switch (logoState.svg_position) {
                case "left":
                  logoPositionStyle = `position:absolute; left:4px; top:0; bottom:0; display:flex; align-items:center; z-index: 10; padding-right: 4px; border-right: ${lineStyle};`;
                  element.style.paddingLeft = `${logoPaddingSize}px`;
                  break;
                case "right":
                  logoPositionStyle = `position:absolute; right:4px; top:0; bottom:0; display:flex; align-items:center; z-index: 10; padding-left: 4px; border-left: ${lineStyle};`;
                  element.style.paddingRight = `${logoPaddingSize}px`;
                  break;
                case "top":
                  logoPositionStyle = `position:absolute; top:4px; left:0; right:0; display:flex; justify-content:center; z-index: 10; padding-bottom: 4px; border-bottom: ${lineStyle};`;
                  element.style.paddingTop = `${logoPaddingSize}px`;
                  break;
                case "bottom":
                  logoPositionStyle = `position:absolute; bottom:4px; left:0; right:0; display:flex; justify-content:center; z-index: 10; padding-top: 4px; border-top: ${lineStyle};`;
                  element.style.paddingBottom = `${logoPaddingSize}px`;
                  break;
              }
              logoSvgContainer = `<div class="logo-wrapper" style="${logoPositionStyle}">${logoSvgContent}</div>`;
            }

            // --- 2. PER-LABEL ICON LOGIC ---
            let svgContainer = "";
            const selectedSvgData = svgLibrary.find(
              (item) => item.name === current_state.svg_name
            );

            if (current_state.svg_name !== "none" && selectedSvgData) {
              const svgStyle = `style="width:${current_state.svg_size}px; height:${current_state.svg_size}px;"`;
              const singleSvgHtml = `<div class="svg-instance" ${svgStyle}>${selectedSvgData.svg}</div>`;
              const svgContent = singleSvgHtml.repeat(current_state.svg_count);
              let svgPositionStyle = "display:none;";
              const sizeWithGap = parseInt(current_state.svg_size, 10) + 8;
              const totalSvgWidth =
                (parseInt(current_state.svg_size, 10) + 2) *
                current_state.svg_count;
              const logoPaddingLeft = parseInt(element.style.paddingLeft || 0);
              const logoPaddingRight = parseInt(
                element.style.paddingRight || 0
              );

              switch (current_state.svg_position) {
                case "left":
                  svgPositionStyle = `position:absolute; left:${
                    logoPaddingLeft + 4
                  }px; top:0; bottom:0; display:flex; flex-wrap:nowrap; align-items:center; gap:2px;`;
                  paddings.left += totalSvgWidth;
                  break;
                case "right":
                  svgPositionStyle = `position:absolute; right:${
                    logoPaddingRight + 4
                  }px; top:0; bottom:0; display:flex; flex-wrap:nowrap; align-items:center; gap:2px;`;
                  paddings.right += totalSvgWidth;
                  break;
                case "top":
                  svgPositionStyle = `position:absolute; top:${
                    parseInt(element.style.paddingTop || 0) + 4
                  }px; left:${logoPaddingLeft}px; right:${logoPaddingRight}px; display:flex; justify-content:center; align-items:center; gap:2px;`;
                  paddings.top += sizeWithGap;
                  break;
                case "bottom":
                  svgPositionStyle = `position:absolute; bottom:${
                    parseInt(element.style.paddingBottom || 0) + 4
                  }px; left:${logoPaddingLeft}px; right:${logoPaddingRight}px; display:flex; justify-content:center; align-items:center; gap:2px;`;
                  paddings.bottom += sizeWithGap;
                  break;
              }
              svgContainer = `<div class="svg-wrapper" style="${svgPositionStyle}">${svgContent}</div>`;
            }

            // --- 3. TEXT CONTAINER ---
            const textPadding = `padding: ${paddings.top}px ${paddings.right}px ${paddings.bottom}px ${paddings.left}px;`;
            const textContainer = `<div class="text-container" style="${textPadding} width:100%; height:100%; display:grid; font-size:${current_state.size}px; font-weight:${current_state.weight}; line-height:${current_state.line_height}; align-items:${current_state.v_align}; justify-items:${current_state.align}; box-sizing:border-box;"><span>${textContent}</span></div>`;

            // --- 4. COMBINE AND RENDER ---
            element.innerHTML = logoSvgContainer + svgContainer + textContainer;
          });
        }

        function syncControlsToState() {
          const current_state = state[activeStyleTarget];
          Object.values(styleControls.tabs).forEach((tab) =>
            tab.classList.remove("control-active")
          );
          styleControls.tabs[activeStyleTarget].classList.add("control-active");
          styleControls.fontSize.value = current_state.size;
          styleControls.fontSizeValue.value = current_state.size;
          styleControls.lineSpacing.value = current_state.line_height;
          styleControls.lineSpacingValue.textContent =
            current_state.line_height;
          styleControls.fontWeightToggle.classList.toggle(
            "control-active",
            current_state.weight === "bold"
          );
          styleControls.textAlignButtons
            .querySelectorAll("button")
            .forEach((btn) =>
              btn.classList.toggle(
                "control-active",
                btn.dataset.align === current_state.align
              )
            );
          styleControls.verticalAlignButtons
            .querySelectorAll("button")
            .forEach((btn) =>
              btn.classList.toggle(
                "control-active",
                btn.dataset.vAlign === current_state.v_align
              )
            );
          imageControls.select.value = current_state.svg_name;
          imageControls.count.value = current_state.svg_count;
          imageControls.size.value = current_state.svg_size;
          imageControls.sizeValue.textContent = `${current_state.svg_size}px`;
          imageControls.position
            .querySelectorAll("button")
            .forEach((btn) =>
              btn.classList.toggle(
                "control-active",
                btn.dataset.pos === current_state.svg_position
              )
            );
        }

        function syncAllUi() {
          textInputs.label1.value = state.label1.text;
          textInputs.label2.value = state.label2.text;
          syncControlsToState();
          syncLogoControlsToState();
          updatePreview();
        }

        function sanitizeSvg(svgString) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(svgString, "image/svg+xml");
          const svg = doc.querySelector("svg");
          if (!svg || svg.querySelector("parsererror")) return "";
          svg.removeAttribute("style");
          svg.removeAttribute("class");
          svg.setAttribute("width", "100%");
          svg.setAttribute("height", "100%");
          svg.setAttribute("fill", "currentColor");
          svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
          return svg.outerHTML;
        }

        function loadSvgs() {
          svgLibrary = JSON.parse(localStorage.getItem("svgLibrary") || "[]");
          renderSvgLibrary();
        }
        function saveSvgs() {
          localStorage.setItem("svgLibrary", JSON.stringify(svgLibrary));
          renderSvgLibrary();
        }
        function renderSvgLibrary() {
          svgModalControls.gallery.innerHTML = "";
          imageControls.select.innerHTML = '<option value="none">None</option>';
          logoControls.select.innerHTML = '<option value="none">None</option>';
          svgLibrary.forEach((item, index) => {
            const galleryItem = document.createElement("div");
            galleryItem.className = "bg-gray-700 p-2 rounded-lg text-center";
            galleryItem.innerHTML = `<div class="h-20 w-full text-white">${item.svg}</div><p class="text-sm mt-2 truncate">${item.name}</p><button data-index="${index}" class="delete-svg-btn text-xs text-red-400 mt-1">Delete</button>`;
            svgModalControls.gallery.appendChild(galleryItem);
            const option = document.createElement("option");
            option.value = item.name;
            option.textContent = item.name;
            imageControls.select.appendChild(option);
            logoControls.select.appendChild(option.cloneNode(true));
          });
        }
        function addSvg(name, svgString) {
          if (!name.trim() || !svgString)
            return alert("SVG Name and File are required.");
          if (svgLibrary.some((item) => item.name === name))
            return alert("An SVG with this name already exists.");
          const sanitized = sanitizeSvg(svgString);
          if (!sanitized) return alert("Invalid or corrupt SVG file.");
          svgLibrary.push({ name, svg: sanitized });
          saveSvgs();
          svgModalControls.nameInput.value = "";
          svgModalControls.fileInput.value = "";
        }

        Object.values(textInputs).forEach((input) =>
          input.addEventListener("input", updatePreview)
        );
        styleControls.tabs.label1.addEventListener("click", () => {
          activeStyleTarget = "label1";
          syncControlsToState();
        });
        styleControls.tabs.label2.addEventListener("click", () => {
          activeStyleTarget = "label2";
          syncControlsToState();
        });
        const handleFontSizeChange = (v) => {
          state[activeStyleTarget].size = Math.max(
            8,
            Math.min(48, parseInt(v, 10) || 8)
          );
          updatePreview();
          syncControlsToState();
        };
        styleControls.fontSize.addEventListener("input", (e) =>
          handleFontSizeChange(e.target.value)
        );
        styleControls.fontSizeValue.addEventListener("input", (e) =>
          handleFontSizeChange(e.target.value)
        );
        styleControls.lineSpacing.addEventListener("input", (e) => {
          state[activeStyleTarget].line_height = e.target.value;
          updatePreview();
          syncControlsToState();
        });
        styleControls.fontWeightToggle.addEventListener("click", () => {
          state[activeStyleTarget].weight =
            state[activeStyleTarget].weight === "bold" ? "normal" : "bold";
          updatePreview();
          syncControlsToState();
        });
        styleControls.textAlignButtons.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (btn?.dataset.align) {
            state[activeStyleTarget].align = btn.dataset.align;
            updatePreview();
            syncControlsToState();
          }
        });
        styleControls.verticalAlignButtons.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (btn?.dataset.vAlign) {
            state[activeStyleTarget].v_align = btn.dataset.vAlign;
            updatePreview();
            syncControlsToState();
          }
        });
        imageControls.manageBtn.addEventListener("click", () =>
          svgModalControls.modal.classList.remove("hidden")
        );
        imageControls.select.addEventListener("change", (e) => {
          state[activeStyleTarget].svg_name = e.target.value;
          updatePreview();
        });
        imageControls.count.addEventListener("input", (e) => {
          state[activeStyleTarget].svg_count = Math.max(
            1,
            parseInt(e.target.value, 10) || 1
          );
          updatePreview();
        });
        imageControls.position.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (btn?.dataset.pos) {
            state[activeStyleTarget].svg_position = btn.dataset.pos;
            updatePreview();
            syncControlsToState();
          }
        });
        imageControls.size.addEventListener("input", (e) => {
          state[activeStyleTarget].svg_size = e.target.value;
          imageControls.sizeValue.textContent = `${e.target.value}px`;
          updatePreview();
        });
        svgModalControls.closeBtn.addEventListener("click", () =>
          svgModalControls.modal.classList.add("hidden")
        );
        svgModalControls.addBtn.addEventListener("click", () => {
          const n = svgModalControls.nameInput.value,
            f = svgModalControls.fileInput.files[0];
          if (f) {
            const r = new FileReader();
            r.onload = (e) => addSvg(n, e.target.result);
            r.readAsText(f);
          } else {
            alert("Please select a file.");
          }
        });
        svgModalControls.gallery.addEventListener("click", (e) => {
          if (e.target.classList.contains("delete-svg-btn")) {
            if (confirm("Are you sure?")) {
              svgLibrary.splice(e.target.dataset.index, 1);
              saveSvgs();
            }
          }
        });

        // --- LOGO CONTROL LISTENERS ---
        function syncLogoControlsToState() {
          if (!logoState) return;
          logoControls.select.value = logoState.svg_name;
          logoControls.size.value = logoState.svg_size;
          logoControls.sizeValue.textContent = `${logoState.svg_size}px`;
          logoControls.lineToggle.checked = logoState.line_enabled;
          logoControls.position
            .querySelectorAll("button")
            .forEach((btn) =>
              btn.classList.toggle(
                "control-active",
                btn.dataset.pos === logoState.svg_position
              )
            );
        }
        logoControls.select.addEventListener("change", (e) => {
          logoState.svg_name = e.target.value;
          updatePreview();
        });
        logoControls.position.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (btn?.dataset.pos) {
            logoState.svg_position = btn.dataset.pos;
            updatePreview();
            syncLogoControlsToState();
          }
        });
        logoControls.size.addEventListener("input", (e) => {
          logoState.svg_size = e.target.value;
          logoControls.sizeValue.textContent = `${e.target.value}px`;
          updatePreview();
        });
        logoControls.lineToggle.addEventListener("change", (e) => {
          logoState.line_enabled = e.target.checked;
          updatePreview();
        });

        // --- SAVE & LOAD LISTENERS ---
        function saveSettings() {
          const settings = { labelState: state, logoState: logoState };
          localStorage.setItem(
            "thermalLabelSettings",
            JSON.stringify(settings)
          );
          alert("Settings saved!");
        }
        function loadSettings() {
          const savedSettingsJSON = localStorage.getItem(
            "thermalLabelSettings"
          );
          if (savedSettingsJSON) {
            const savedSettings = JSON.parse(savedSettingsJSON);
            state = savedSettings.labelState;
            logoState = savedSettings.logoState;
            syncAllUi();
          }
        }
        settingsButtons.save.addEventListener("click", saveSettings);

        const dimControls = {
          width: document.getElementById("label-width"),
          height: document.getElementById("label-height"),
        };
        const dynamicPrintStyles = document.createElement("style");
        document.head.appendChild(dynamicPrintStyles);
        function updateDimensionsAndPrint() {
          const w_cm = parseFloat(dimControls.width.value) || 5.7;
          const h_cm = parseFloat(dimControls.height.value) || 3.2;

          // Convert cm to inches (1 inch = 2.54 cm)
          const w_in = w_cm / 2.54;
          const h_in = h_cm / 2.54;

          labelPreview.style.width = `${w_in * 96}px`;
          labelPreview.style.height = `${h_in * 96}px`;
          dynamicPrintStyles.innerHTML = `@media print { @page { size: ${w_in}in ${h_in}in; margin: 0; } }`;
        }
        Object.values(dimControls).forEach((c) =>
          c.addEventListener("input", updateDimensionsAndPrint)
        );
        function convertToArabicNumerals(t) {
          const a = ["٠", "١", "٢", "٣", "٤", "٥", "٦", "٧", "٨", "٩"];
          return String(t).replace(/[0-9]/g, (d) => a[parseInt(d)]);
        }
        const settingsModal = document.getElementById("settings-modal");
        document
          .getElementById("settings-button")
          .addEventListener("click", () =>
            settingsModal.classList.remove("hidden")
          );
        document
          .getElementById("close-settings-button")
          .addEventListener("click", () =>
            settingsModal.classList.add("hidden")
          );
        document
          .getElementById("print-button")
          .addEventListener("click", () => window.print());

        // --- INITIALIZE APP ---
        loadSvgs();
        loadSettings(); // Auto-load settings on start
        updateDimensionsAndPrint();
        syncAllUi();
      });
    </script>
  </body>
</html>
